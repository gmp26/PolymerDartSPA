<!-- import polymer-element's definition -->
<link rel="import" href="../../packages/polymer/polymer.html">

<polymer-element name="code-blockly">
  <template>
    <style>
      :host {
        display: block;
        width:100%;
        height: 100%;
      }
      :host iframe {
        width:100%;
        height: 100%;
      }
    </style>
    <!-- Template content here -->
    <h2>Code Blockly</h2>
    <button on-click="{{run}}">Run</button>
    <iframe src="../blockly.html"></iframe>
  </template>
  <script type="application/dart" src="code_blockly.dart"></script>
  <script src="../../packages/browser/dart.js"></script>
  <script src="../web/acorn/acorn_interpreter.js"></script>
  <script>
    
    function blocklyLoaded(blockly) {
      // Called once Blockly is fully loaded.
      window.Coder = {
        blockly: blockly,
        foo: function(p) {console.log(p);},
        run: function() {
          if(interp = getInterpreter())
            interp.run();
        }
      };
    }
    function initApi(interpreter, scope) {
      // Add an API function for the alert() block.
      var wrapper = function(text) {
        text = initApi ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));
  
      // Add an API function for the prompt() block.
      wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));
    }
    function getInterpreter() {
      var code = window.Coder.blockly.JavaScript.workspaceToCode();
      if(code) {
      	return new Interpreter(code, initApi);
      }
      else {
        return null;
      }
    }
  </script>
</polymer-element>

